{% extends 'layouts/super_admin_base.html' %}

{% import 'macros/common_macros.html' as common_macros %}
{% import 'macros/compliance_macros.html' as compliance_macros %}

{% block page_content %}
<div class="container-fluid pt-0">  {# was: py-4 ‚Äî avoid double top padding #}

  {# üöÄ Onboarding banner (kept; shows only when needed) #}
  {% if SHOW_ONBOARDING_BANNER %}
    <div class="alert alert-info d-flex align-items-center justify-content-between shadow-sm" role="alert">
      <div class="d-flex align-items-center">
        <i class="material-icons me-2">rocket_launch</i>
        <div>
          <strong>Finish setting up your organization.</strong>
          <div class="small">
            Start the onboarding wizard to add company details and branding. You can customize everything later in Settings.
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  {# üîù Unified Contracts KPI #}
  <div class="row g-4 mt-1">
    <div class="col-12">
      <div class="card shadow-sm border">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-2">
              <h6 class="mb-0">Contracts</h6>
            </div>
            <a class="btn btn-sm btn-outline-primary"
               href="{{ url_for('super_admin_contracts.contracts_overview') }}">
              Open Overview
            </a>
          </div>

          <div class="row text-center mt-3">
            <div class="col-12 col-sm-3">
              <div class="fw-semibold fs-3 text-danger">{{ contracts_expired or 0 }}</div>
              <div class="small text-secondary">Expired</div>
            </div>
            <div class="col-12 col-sm-3">
              <div class="fw-semibold fs-3 text-warning">{{ contracts_expiring_30 or 0 }}</div>
              <div class="small text-secondary">Expiring ‚â§ 30d</div>
            </div>
            <div class="col-12 col-sm-3">
              <div class="fw-semibold fs-3 text-primary">{{ contracts_expiring_60 or 0 }}</div>
              <div class="small text-secondary">Expiring ‚â§ 60d</div>
            </div>
            <div class="col-12 col-sm-3">
              <div class="fw-semibold fs-3 text-info">{{ contracts_expiring_90 or 0 }}</div>
              <div class="small text-secondary">Expiring ‚â§ 90d</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- üì¶ Row: Summary Tiles -->
  <div class="row g-4 mt-2">
    {{ common_macros.metric_tile("Total Clients",       total_clients or 0,      "groups",            "primary",   "super_admin.manage_clients") }}
    {{ common_macros.metric_tile("Total PMs",           total_pms or 0,          "supervisor_account","info",      "super_admin.manage_users", {'role_filter': 'Property Manager'}) }}
    {{ common_macros.metric_tile("Total Contractors",   total_contractors or 0,  "engineering",       "warning",   "super_admin.manage_users", {'role_filter': 'Contractor'}) }}
    {{ common_macros.metric_tile("Managed Portfolio",   (managed_portfolio_value or 0) | currency(currency_code|default('EUR')), "folder_shared", "secondary", "super_admin.manage_clients") }}
  </div>

  <!-- üìã Row: Compliance & Insights -->
  <div class="row g-4 mt-2">
    {{ common_macros.metric_tile("Upcoming AGMs", upcoming_agm_count or 0, "calendar_month", "success", "super_admin.upcoming_agms") }}
    {{ compliance_macros.compliance_tile("Client Compliance Docs", client_compliance_docs or [], "file-contract", "primary", "super_admin.compliance_documents_index") }}
    {{ compliance_macros.compliance_tile("Contractor Compliance Docs", contractor_compliance_docs or [], "file-shield", "secondary", "super_admin.contractor_compliance_documents") }}
    {{ common_macros.metric_tile("Expiring Docs", expiring_docs_count or 0, "hourglass_empty", "warning", "super_admin.client_expiring_documents") }}
    {{ common_macros.metric_tile("Missing Client Docs", clients_missing_docs or 0, "report_problem", "danger", "super_admin.compliance_documents_index") }}
    {{ common_macros.metric_tile("Missing Contractor Docs", contractors_missing_docs or 0, "warning_amber", "danger", "super_admin.contractor_compliance_documents") }}
    {{ common_macros.metric_tile("GAR Insights", gar_flagged_count or 0, "smart_toy", "info", "super_admin.gar_insights") }}
  </div>

  <!-- üöß Logix Modules Row -->
  <div class="row g-4 mt-2">
    <div class="col-md-4">
      <div class="card h-100 text-center shadow-sm border">
        <div class="card-body">
          <i class="fas fa-tools fa-2x mb-2 text-warning"></i>
          <h5 class="card-title">Works Logix</h5>
          <p class="card-text">Manage Work Orders & Contractor Assignments</p>
          {% if 'super_admin.work_orders' in current_app.view_functions %}
            <a href="{{ url_for('super_admin.work_orders') }}" class="btn btn-outline-primary btn-sm">Open</a>
          {% else %}
            <a href="#" class="btn btn-outline-primary btn-sm disabled">Coming Soon</a>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card h-100 text-center shadow-sm border">
        <div class="card-body">
          <i class="fas fa-coins fa-2x mb-2 text-success"></i>
          <h5 class="card-title">Finance Logix</h5>
          <p class="card-text">Service Charge Oversight & Payment Tracking</p>
          <a href="#" class="btn btn-outline-secondary btn-sm disabled">Planned</a>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card h-100 text-center shadow-sm border">
        <div class="card-body">
          <i class="fas fa-users-cog fa-2x mb-2 text-info"></i>
          <h5 class="card-title">HR Logix</h5>
          <p class="card-text">Manage Internal & Contractor Staff Records</p>
          <a href="#" class="btn btn-outline-info btn-sm disabled">Pending</a>
        </div>
      </div>
    </div>
  </div>

  <!-- üîç Audit Log Preview -->
  {% if audit_logs %}
  <div class="card mt-5 shadow-sm">
    <div class="card-header pb-0">
      <h6 class="mb-0">üïµÔ∏è Recent Audit Logs</h6>
    </div>
    <div class="card-body px-4 pt-3 pb-3">
      <ul class="list-group list-group-flush">
        {% for log in audit_logs[:5] %}
        <li class="list-group-item px-0 d-flex justify-content-between">
          <span><strong>{{ log.user_name }}</strong> ‚Äî {{ log.change_type }} on <em>{{ log.target_model }}</em></span>
          <span class="text-muted text-xs">{{ log.timestamp.strftime('%d %b %Y %H:%M') }}</span>
        </li>
        {% endfor %}
      </ul>
      <div class="text-end mt-2">
        <a href="{{ url_for('super_admin.audit_logs') }}" class="btn btn-link text-sm">View Full Log ‚Üí</a>
      </div>
    </div>
  </div>
  {% endif %}

</div>
{% endblock %}
