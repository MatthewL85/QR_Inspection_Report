{% extends 'layouts/super_admin_base.html' %}

{% block page_content %}
<div class="container-fluid py-4">

  <!-- 🔍 Filter & Search Bar -->
  <form method="GET" action="{{ url_for('super_admin.compliance_documents') }}" class="row g-2 px-3 mb-4">
    <div class="col-md-3">
      <input type="text" name="search" class="form-control" placeholder="Search filename, description, summary"
             value="{{ request.args.get('search', '') }}">
    </div>
    <div class="col-md-2">
      <select name="client_id" class="form-select">
        <option value="">All Clients</option>
        {% for client in clients %}
          <option value="{{ client.id }}" {% if request.args.get('client_id') == client.id|string %}selected{% endif %}>{{ client.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <select name="document_type" class="form-select">
        <option value="">All Types</option>
        {% for type in document_types %}
          <option value="{{ type }}" {% if request.args.get('document_type') == type %}selected{% endif %}>{{ type }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <select name="ai_status" class="form-select">
        <option value="">AI Status</option>
        {% for status in ai_statuses %}
          <option value="{{ status }}" {% if request.args.get('ai_status') == status %}selected{% endif %}>{{ status }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <button type="submit" class="btn btn-primary w-100">
        <i class="material-icons me-1">filter_list</i> Filter
      </button>
    </div>
  </form>

  <!-- 📄 Compliance Documents Table -->
  <div class="card mb-4">
    <div class="card-header pb-0 d-flex justify-content-between align-items-center">
      <h6 class="mb-0">📄 Compliance Documents</h6>
      <a href="{{ url_for('super_admin.upload_compliance_document') }}" class="btn btn-success btn-sm">
        <i class="material-icons me-1">upload</i> Upload Document
      </a>
    </div>

    <div class="card-body px-0 pt-0 pb-2">
      <div class="table-responsive p-3">
        <table class="table table-hover align-items-center mb-0">
          <thead>
            <tr>
              <th>File</th>
              <th>Type</th>
              <th>Description</th>
              <th>Client</th>
              <th>Uploaded By</th>
              <th>Expiry</th>
              <th>AI Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for doc in documents.items %}
            <tr>
              <td style="max-width: 200px;">
                <a href="{{ url_for('static', filename=doc.file_path) }}" target="_blank">{{ doc.file_name }}</a>
              </td>
              <td>{{ doc.document_type or '-' }}</td>
              <td style="max-width: 250px;" class="text-truncate" title="{{ doc.description }}">{{ doc.description or '-' }}</td>
              <td>{{ doc.client.name if doc.client else '-' }}</td>
              <td>{{ doc.uploaded_by.full_name if doc.uploaded_by else '-' }}</td>
              <td>
                {% if doc.expiry_date %}
                  {% if doc.expiry_date < current_date %}
                    <span class="badge bg-danger" data-bs-toggle="tooltip" title="Expired on {{ doc.expiry_date.strftime('%d %b %Y') }}">
                      ⚠ Expired
                    </span>
                  {% else %}
                    {{ doc.expiry_date.strftime('%d %b %Y') }}
                  {% endif %}
                {% else %}
                  —
                {% endif %}
              </td>
              <td>
                {% if doc.ai_status == 'Reviewed' %}
                  <span class="badge bg-success">✔ Reviewed</span>
                {% elif doc.ai_status == 'Parsed' %}
                  <span class="badge bg-info text-dark">Parsed</span>
                {% elif doc.ai_status == 'Pending' %}
                  <span class="badge bg-warning text-dark">Pending</span>
                {% else %}
                  <span class="badge bg-secondary">—</span>
                {% endif %}
              </td>
              <td>
                {% if user.role.name == 'Super Admin' %}
                  <a href="{{ url_for('super_admin.review_compliance_document', doc_id=doc.id) }}"
                     class="btn btn-sm btn-primary mb-1">
                    <i class="material-icons">visibility</i> Review
                  </a>
                  <a href="{{ url_for('static', filename=doc.file_path) }}"
                     class="btn btn-sm btn-info mb-1" download>
                    <i class="material-icons">download</i>
                  </a>
                  <a href="{{ url_for('super_admin.delete_compliance_document', doc_id=doc.id) }}"
                     class="btn btn-sm btn-danger mb-1"
                     onclick="return confirm('Are you sure you want to delete this document?')">
                    <i class="material-icons">delete</i>
                  </a>
                {% else %}
                  <span class="text-muted">Restricted</span>
                {% endif %}
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="8" class="text-center text-muted py-4">No documents found.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 📄 Pagination -->
  <div class="d-flex justify-content-end px-4">
    <nav>
      <ul class="pagination mb-0">
        {% if documents.has_prev %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('super_admin.compliance_documents', page=documents.prev_num, search=request.args.get('search'), client_id=request.args.get('client_id'), document_type=request.args.get('document_type'), ai_status=request.args.get('ai_status')) }}">Previous</a>
          </li>
        {% endif %}
        <li class="page-item disabled">
          <span class="page-link">Page {{ documents.page }} of {{ documents.pages }}</span>
        </li>
        {% if documents.has_next %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('super_admin.compliance_documents', page=documents.next_num, search=request.args.get('search'), client_id=request.args.get('client_id'), document_type=request.args.get('document_type'), ai_status=request.args.get('ai_status')) }}">Next</a>
          </li>
        {% endif %}
      </ul>
    </nav>
  </div>

</div>

<!-- 🧠 Tooltip Init -->
<script>
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
  tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el))
</script>
{% endblock %}
