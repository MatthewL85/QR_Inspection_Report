{% extends 'layouts/super_admin_base.html' %}

{% block page_content %}
<div class="container-fluid py-4">

  <!-- ‚úÖ Flash Alerts -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0">üìã Client Compliance Documents</h4>
    <a href="{{ url_for('super_admin.upload_client_compliance_document') }}" class="btn btn-primary">
      <i class="material-icons me-1">upload</i> Upload New
    </a>
  </div>

  <!-- Filters -->
  <form method="GET" class="row g-3 mb-4">
    <div class="col-md-3">
      <label for="client_id" class="form-label">Client</label>
      <select name="client_id" id="client_id" class="form-select">
        <option value="">All Clients</option>
        {% for client in clients %}
          <option value="{{ client.id }}" {% if client.id == request.args.get('client_id', type=int) %}selected{% endif %}>
            {{ client.name }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label for="document_type" class="form-label">Document Type</label>
      <input type="text" name="document_type" id="document_type" class="form-control" value="{{ request.args.get('document_type', '') }}">
    </div>
    <div class="col-md-3">
      <label for="ai_status" class="form-label">AI Status</label>
      <select name="ai_status" id="ai_status" class="form-select">
        <option value="">All</option>
        {% for status in ai_statuses %}
          <option value="{{ status }}" {% if status == request.args.get('ai_status') %}selected{% endif %}>{{ status }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3 align-self-end">
      <button type="submit" class="btn btn-outline-primary w-100">
        <i class="material-icons me-1">search</i> Filter
      </button>
    </div>
  </form>

  <!-- ‚úÖ Bulk Delete Form -->
  <form method="POST" action="{{ url_for('super_admin.delete_selected_client_compliance') }}">
    {{ csrf_token() }}
    <div class="d-flex align-items-center mb-2">
      <input type="checkbox" id="select_all" class="form-check-input me-2">
      <label for="select_all" class="form-label me-auto mb-0">Select All</label>
      <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete the selected documents?')">
        <i class="material-icons me-1">delete</i> Delete Selected
      </button>
    </div>

    <div class="card shadow-sm">
      <div class="table-responsive">
        <table class="table table-hover align-items-center mb-0">
          <thead class="bg-light">
            <tr>
              <th><input type="checkbox" id="select_all_top" class="form-check-input"></th>
              <th>üìÑ Name</th>
              <th>üè¢ Client</th>
              <th>üìÇ Type</th>
              <th>üìÖ Expiry</th>
              <th>ü§ñ AI</th>
              <th>üîê Status</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for doc in documents.items %}
              <tr>
                <td><input type="checkbox" name="selected_ids" value="{{ doc.id }}" class="form-check-input"></td>
                <td>{{ doc.document_name }}</td>
                <td>{{ doc.client.name }}</td>
                <td>{{ doc.document_type }}</td>
                <td>
                  {% if doc.expires_at %}
                    {% if doc.expires_at.date() < current_date %}
                      <span class="badge bg-danger">Expired</span><br>
                    {% endif %}
                    {{ doc.expires_at.strftime('%d-%b-%Y') }}
                  {% else %}‚Äî{% endif %}
                </td>
                <td>
                  {% if doc.reviewed_by_ai %}
                    <span class="badge bg-success">Reviewed</span>
                  {% else %}
                    <span class="badge bg-warning text-dark">Pending</span>
                  {% endif %}
                </td>
                <td>
                  <span class="badge bg-{{ 'secondary' if doc.status == 'archived' else 'info' if doc.status == 'expired' else 'primary' }}">
                    {{ doc.status.capitalize() }}
                  </span>
                </td>
                <td class="text-end">
                  <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#compliancePreviewModal{{ doc.id }}">
                    <i class="material-icons">visibility</i>
                  </button>
                  <a href="{{ url_for('super_admin.edit_client_compliance_document', doc_id=doc.id) }}" class="btn btn-sm btn-outline-warning">
                    <i class="material-icons">edit</i>
                  </a>
                  <a href="{{ url_for('static', filename=doc.file_path) }}" download class="btn btn-sm btn-outline-secondary">
                    <i class="material-icons">download</i>
                  </a>
                  <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal{{ doc.id }}">
                    <i class="material-icons">delete</i>
                  </button>
                </td>
              </tr>

              {% include 'shared/modals/_client_compliance_preview_modal.html' %}

              <!-- ‚úÖ Delete Modal -->
              <div class="modal fade" id="confirmDeleteModal{{ doc.id }}" tabindex="-1" aria-labelledby="confirmDeleteLabel{{ doc.id }}" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content border-0 shadow">
                    <div class="modal-header bg-danger text-white">
                      <h5 class="modal-title" id="confirmDeleteLabel{{ doc.id }}">Delete Document</h5>
                      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      Are you sure you want to permanently delete <strong>{{ doc.document_name }}</strong> for <strong>{{ doc.client.name }}</strong>?<br>This action cannot be undone.
                    </div>
                    <div class="modal-footer bg-light">
                      <form method="POST" action="{{ url_for('super_admin.delete_client_compliance_document', doc_id=doc.id) }}">
                        {{ csrf_token() }}
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">
                          <i class="material-icons me-1">delete_forever</i> Delete
                        </button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>

            {% else %}
              <tr><td colspan="8" class="text-center py-4">No documents found.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="card-footer d-flex justify-content-between align-items-center">
        <div class="text-muted">
          Showing {{ documents.start_index() }} to {{ documents.end_index() }} of {{ documents.total }}
        </div>
        <div>
          {% if documents.has_prev %}
            <a href="{{ url_for('super_admin.client_compliance_documents', page=documents.prev_num, **request.args.to_dict()) }}" class="btn btn-outline-secondary btn-sm">Previous</a>
          {% endif %}
          {% if documents.has_next %}
            <a href="{{ url_for('super_admin.client_compliance_documents', page=documents.next_num, **request.args.to_dict()) }}" class="btn btn-outline-secondary btn-sm">Next</a>
          {% endif %}
        </div>
      </div>
    </div>
  </form>
</div>

<!-- ‚úÖ Select All JavaScript -->
<script>
  document.getElementById('select_all')?.addEventListener('change', function () {
    document.querySelectorAll('input[name="selected_ids"]').forEach(cb => cb.checked = this.checked);
    document.getElementById('select_all_top').checked = this.checked;
  });

  document.getElementById('select_all_top')?.addEventListener('change', function () {
    document.querySelectorAll('input[name="selected_ids"]').forEach(cb => cb.checked = this.checked);
    document.getElementById('select_all').checked = this.checked;
  });
</script>

{% endblock %}
