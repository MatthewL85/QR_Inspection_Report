{% extends "layouts/super_admin_base.html" %}
{% block title %}Company Profile | LogixPM{% endblock %}

{% block page_content %}
<div class="container-fluid py-4">
  <div class="card border-0 shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Company Profile</h5>
        {% if 'super_admin.dashboard' in current_app.view_functions %}
          <a href="{{ url_for('super_admin.dashboard') }}" class="btn btn-light btn-sm">← Dashboard</a>
        {% endif %}
      </div>

      <form method="post" novalidate>
        {{ form.csrf_token }}
        <div class="row g-3">
          <div class="col-md-6">{{ form.name.label }} {{ form.name(class="form-control") }}</div>
          <div class="col-md-6">{{ form.registration_number.label }} {{ form.registration_number(class="form-control") }}</div>
          <div class="col-md-6">{{ form.vat_number.label }} {{ form.vat_number(class="form-control") }}</div>
          <div class="col-md-6">{{ form.tax_identifier.label }} {{ form.tax_identifier(class="form-control") }}</div>
          <div class="col-md-6">{{ form.company_type.label }} {{ form.company_type(class="form-control") }}</div>
          <div class="col-md-6">{{ form.industry.label }} {{ form.industry(class="form-control") }}</div>

          <div class="col-md-6">{{ form.email.label }} {{ form.email(class="form-control") }}</div>
          <div class="col-md-6">{{ form.phone.label }} {{ form.phone(class="form-control") }}</div>
          <div class="col-md-6">{{ form.website.label }} {{ form.website(class="form-control") }}</div>

          <div class="col-md-6">{{ form.address_line1.label }} {{ form.address_line1(class="form-control") }}</div>
          <div class="col-md-6">{{ form.address_line2.label }} {{ form.address_line2(class="form-control") }}</div>
          <div class="col-md-4">{{ form.city.label }} {{ form.city(class="form-control") }}</div>
          <div class="col-md-4">{{ form.state.label }} {{ form.state(class="form-control") }}</div>
          <div class="col-md-4">{{ form.postal_code.label }} {{ form.postal_code(class="form-control") }}</div>
          <div class="col-md-4">{{ form.country.label }} {{ form.country(class="form-control") }}</div>

          <div class="col-md-4">{{ form.currency.label }} {{ form.currency(class="form-control") }}</div>
          <div class="col-md-4">{{ form.timezone.label }} {{ form.timezone(class="form-control") }}</div>
          <div class="col-md-4">{{ form.preferred_language.label }} {{ form.preferred_language(class="form-control") }}</div>
        </div>

        <div class="mt-3">
          {{ form.submit(class="btn btn-primary") }}
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function () {
  // Country → jurisdiction mapping
  const JURIS = {
    "Ireland": {
      postalLabel: "Eircode",
      postalPlaceholder: "e.g. D02 X285",
      postalPattern: "^[A-Za-z]\\d{2}\\s?[A-Za-z0-9]{4}$", // soft validation
      stateLabel: "County",
      tzDefault: "Europe/Dublin",
      langDefault: "en"
    },
    "United Kingdom": {
      postalLabel: "Postcode",
      postalPlaceholder: "e.g. SW1A 1AA",
      postalPattern: "", // UK postcode is complex; keep guidance only
      stateLabel: "County",
      tzDefault: "Europe/London",
      langDefault: "en"
    },
    "United States": {
      postalLabel: "ZIP code",
      postalPlaceholder: "e.g. 94103",
      postalPattern: "^\\d{5}(-\\d{4})?$",
      stateLabel: "State",
      tzDefault: "", // not auto-setting for US in this app
      langDefault: "en"
    },
    "Other": {
      postalLabel: "Postal Code",
      postalPlaceholder: "e.g. 1000",
      postalPattern: "",
      stateLabel: "State / Region",
      tzDefault: "",
      langDefault: ""
    }
  };

  const DEFAULTS = {
    postalLabel: "Postal Code",
    postalPlaceholder: "e.g. 1000",
    postalPattern: "",
    stateLabel: "State / Region",
    tzDefault: "",
    langDefault: ""
  };

  // Grab inputs + labels
  const countrySel = document.getElementById("{{ form.country.id }}");
  const postalInput = document.getElementById("{{ form.postal_code.id }}");
  const stateInput  = document.getElementById("{{ form.state.id }}");
  const tzSel       = document.getElementById("{{ form.timezone.id }}");
  const langSel     = document.getElementById("{{ form.preferred_language.id }}");

  const postalLabelEl = document.querySelector('label[for="{{ form.postal_code.id }}"]');
  const stateLabelEl  = document.querySelector('label[for="{{ form.state.id }}"]');

  // Helpers for safe value check (avoid auto-overwriting user's explicit choice)
  function isEmptyValue(v){ return v === null || v === undefined || (""+v).trim() === ""; }

  function applyJurisdiction(country, {onlyIfEmptyTZLang=false} = {}) {
    const j = JURIS[country] || DEFAULTS;

    if (postalLabelEl) postalLabelEl.textContent = j.postalLabel;
    if (postalInput) {
      postalInput.placeholder = j.postalPlaceholder || "";
      if (j.postalPattern) {
        postalInput.setAttribute("pattern", j.postalPattern);
        postalInput.setAttribute("title", j.postalPlaceholder || j.postalLabel);
      } else {
        postalInput.removeAttribute("pattern");
        postalInput.removeAttribute("title");
      }
    }

    if (stateLabelEl) stateLabelEl.textContent = j.stateLabel;
    if (stateInput) stateInput.placeholder = j.stateLabel;

    // Optional auto-select timezone / language if blank (or if we don't restrict)
    if (tzSel && j.tzDefault) {
      if (!onlyIfEmptyTZLang || isEmptyValue(tzSel.value)) tzSel.value = j.tzDefault;
    }
    if (langSel && j.langDefault) {
      if (!onlyIfEmptyTZLang || isEmptyValue(langSel.value)) langSel.value = j.langDefault;
    }
  }

  if (countrySel) {
    // On initial load: apply and only set tz/lang if currently empty
    applyJurisdiction(countrySel.value, {onlyIfEmptyTZLang: true});

    // On change: update labels/placeholders and set tz/lang if empty
    countrySel.addEventListener("change", function () {
      applyJurisdiction(countrySel.value, {onlyIfEmptyTZLang: true});
    });
  }
})();
</script>
{% endblock %}
